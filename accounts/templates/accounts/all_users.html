{% extends "base.html" %}

{% block title %}Пользователи{% endblock %}

{% block content %}
<div class="card shadow-sm p-4">

    <h3 class="mb-4 text-center">
        <i class="bi bi-people-fill"></i> Все пользователи
    </h3>

    <!-- Поиск -->
    <div class="input-group mb-4">
        <input
            type="text"
            id="searchInput"
            class="form-control"
            placeholder="Введите имя пользователя..."
            onkeypress="if(event.key === 'Enter') searchUsers()"
        >
        <button class="btn btn-primary" onclick="searchUsers()">
            <i class="bi bi-search"></i> Поиск
        </button>
    </div>

    <!-- Список пользователей -->
    <ul class="list-group" id="usersList">
        {% for u in users %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    {% if u.profile.avatar %}
                        <img src="{{ u.profile.avatar.url }}"
                             alt="{{ u.username }}"
                             class="rounded-circle"
                             style="width: 40px; height: 40px; object-fit: cover;">
                    {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ u.username }}&size=40"
                             alt="{{ u.username }}"
                             class="rounded-circle">
                    {% endif %}

                    <a href="{% url 'accounts:profile' u.id %}"
                       class="text-decoration-none fw-bold">
                        {{ u.username }}
                    </a>
                </div>

                <!-- ОТПРАВКА ЗАЯВКИ (POST) -->
                <form action="{% url 'accounts:send_friend_request' u.id %}"
                      method="post"
                      class="m-0">
                    {% csrf_token %}
                    <button type="submit"
                            class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-person-plus"></i> Добавить
                    </button>
                </form>
            </li>
        {% empty %}
            <li class="list-group-item text-muted text-center py-5">
                <i class="bi bi-person-x" style="font-size: 3rem;"></i>
                <p class="mt-2 mb-0">Пользователей нет</p>
            </li>
        {% endfor %}
    </ul>

    <!-- Индикатор загрузки -->
    <div id="loadingIndicator" class="text-center py-4 d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
async function searchUsers() {
    const query = document.getElementById('searchInput').value.trim();
    const list = document.getElementById('usersList');
    const loading = document.getElementById('loadingIndicator');

    loading.classList.remove('d-none');
    list.style.opacity = '0.5';

    try {
        const response = await fetch(`/accounts/search-users/?q=${encodeURIComponent(query)}`);
        const result = await response.json();

        loading.classList.add('d-none');
        list.style.opacity = '1';
        list.innerHTML = '';

        if (!result.users || result.users.length === 0) {
            list.innerHTML = `
                <li class="list-group-item text-muted text-center py-5">
                    <i class="bi bi-search" style="font-size: 3rem;"></i>
                    <p class="mt-2 mb-0">Ничего не найдено</p>
                    <small>Попробуйте изменить запрос</small>
                </li>
            `;
            return;
        }

        result.users.forEach(user => {
            const avatar = user.avatar
                ? user.avatar
                : `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&size=40`;

            list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <img src="${avatar}"
                             class="rounded-circle"
                             style="width:40px;height:40px;object-fit:cover;">
                        <a href="/accounts/profile/${user.id}/"
                           class="fw-bold text-decoration-none">
                            ${user.username}
                        </a>
                    </div>

                    <form action="/accounts/send-request/${user.id}/"
                          method="post"
                          class="m-0">
                        <input type="hidden" name="csrfmiddlewaretoken"
                               value="{{ csrf_token }}">
                        <button type="submit"
                                class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-person-plus"></i> Добавить
                        </button>
                    </form>
                </li>
            `;
        });

    } catch (e) {
        loading.classList.add('d-none');
        list.style.opacity = '1';
        list.innerHTML = `
            <li class="list-group-item text-danger text-center py-4">
                <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                <p class="mt-2 mb-0">Ошибка загрузки</p>
            </li>
        `;
    }
}

// Очистка поиска по Esc
document.getElementById('searchInput').addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        this.value = '';
        location.reload();
    }
});
</script>
{% endblock %}
